# Copilot Instructions

- **Architecture**: ASP.NET Core 9 API with Entra ID auth via Microsoft.Identity.Web. API startup lives in [src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Program.cs](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Program.cs); controllers are versioned using Asp.Versioning and routed as `api/v{version}`.
- **Projects**: Solution [src/XtremeIdiots.Portal.Integrations.Servers.sln](src/XtremeIdiots.Portal.Integrations.Servers.sln) includes Abstractions DTOs/interfaces, API, generated API client, and unit/integration tests.
- **Authentication/Authorization**: Controllers are `[Authorize(Roles = "ServiceAccount")]`; only root and `/api/health` allow anonymous. Ensure Entra audience/authority is configured in appsettings or environment.
- **Configuration**: Optional Azure App Configuration load (key prefix `XtremeIdiots.Portal.Integrations.Servers.Api.V1:`) and Key Vault credential in [Program.cs](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Program.cs). Repository API client requires `RepositoryApi:BaseUrl` and `RepositoryApi:ApplicationAudience`.
- **Telemetry**: Application Insights wired with adaptive sampling; `TelemetryInitializer` sets role name in [src/.../TelemetryInitializer.cs](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/TelemetryInitializer.cs). Dependency telemetry is created around RCON/query/FTP calls.
- **HTTP surface**: Controllers under [src/.../Controllers/V1](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Controllers/V1) expose query, RCON, and map-sync endpoints. Responses use MX.Api `ApiResponse`/`ApiResult` helpers and `ToHttpResult()` extension.
- **Game server integrations**:
  - Query operations use `IQueryClientFactory` from [src/.../Factories](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Factories) and cache responses for 5 minutes in [QueryController](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Controllers/V1/QueryController.cs).
  - RCON operations instantiate protocol-specific clients via `IRconClientFactory` in [RconController](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Controllers/V1/RconController.cs); player operations verify server data via Repository API first.
  - Map sync talks to server FTP hosts via `FluentFTP` in [MapsController](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Controllers/V1/MapsController.cs); accepts a self-signed certificate when thumbprint matches `xtremeidiots_ftp_certificate_thumbprint`.
- **Portal integration**: All server metadata and map definitions come from the Portal Repository API via the generated client in [src/XtremeIdiots.Portal.Repository.Api.Client.V1](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Clients) configured in Program startup.
- **Local development**: Typical loop (from docs) `dotnet clean src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/XtremeIdiots.Portal.Integrations.Servers.Api.V1.csproj && dotnet build ... && dotnet test src --filter "FullyQualifiedName!~IntegrationTests"`.
- **Tests**: Unit tests live under [src/XtremeIdiots.Portal.Integrations.Servers.Api.Tests.V1](src/XtremeIdiots.Portal.Integrations.Servers.Api.Tests.V1); integration tests under [src/XtremeIdiots.Portal.Integrations.Servers.Api.IntegrationTests.V1](src/XtremeIdiots.Portal.Integrations.Servers.Api.IntegrationTests.V1). Keep new tests in the appropriate project; default pipelines exclude integration tests unless explicitly run.
- **CI/CD workflows**: Key workflows in [.github/workflows](.github/workflows) â€” `build-and-test` for feature branches, `pr-verify` for PR validation (with Terraform plans), `deploy-dev` manual apply, `deploy-prd` on main, `codequality` weekly/PR, `release-version-and-tag` then `release-publish-nuget` for NuGet releases.
- **Environment secrets**: OIDC vars `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, and `AZURE_SUBSCRIPTION_ID` are defined at the GitHub environment level; app settings should prefer managed identity for App Config/Key Vault when available.
- **Docs**: See [docs/development-workflows.md](docs/development-workflows.md) for branch/CI rules and [docs/manual-steps.md](docs/manual-steps.md) for any post-deploy actions.
- **Patterns**: Prefer factories (`IQueryClientFactory`, `IRconClientFactory`) over direct client instantiation to keep protocol handling testable. Cache expensive query calls via `IMemoryCache` with short TTLs. Wrap external calls with telemetry operations and track exceptions/events consistently.
- **Swagger**: Swagger is enabled only in development; versioned docs are built per API version via [ConfigureSwaggerOptions](src/XtremeIdiots.Portal.Integrations.Servers.Api.V1/Configuration/ConfigureSwaggerOptions.cs).
- **Health**: `/api/health` is anonymous; use for liveness probes. Root `/` returns `OK` for simple diagnostics.
- **NuGet**: Abstractions and API client projects are packaged and published by the release workflows; avoid breaking contracts without bumping versions accordingly.
